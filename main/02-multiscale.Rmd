---
title: Multiscale (multi-resolution) analysis of Chlorophyll data
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
  github_document: default
---

```{r global_options, include=TRUE}
knitr::opts_chunk$set(fig.width=14, fig.height=8, echo=TRUE, eval=TRUE, cache=FALSE,
                      warning=FALSE, message=FALSE,
                      cache.lazy = FALSE)

## Load packages
library(tidyverse)
library(knitr)
library(here)
library(ggplot2)
library(tidync)
devtools::load_all("~/repos/omd/omd") ## Location of OMD R package; replace with library(omd) soon.
```
 
```{r directories}
base = "02-multiscale"
here::i_am("02-multiscale.Rmd")
knitr::opts_chunk$set(fig.path = here::here("data", base, 'figures/'))
datadir = here::here("data", base)
datadir_orig = here::here("data", "00-import-data")
## outputdir = here::here("data", base)
if(!dir.exists(datadir)) dir.create(datadir)
```

# Goal

The goal of this script is to analyze climatology and non-climatology
Chlorophyll data in the North Pacific ocean, and use OMD to see differences at
different *resolutions* of the data.

The datasets are placed in [/data/00-import-data].


# Load non-climatology data

First, we'll load some non-climatology data, from two sources (remote sensing
and Darwin). Here's how to do this:

```{r load-data}
type = "real"
year = 2000
mo = 1
filename = paste0(type, "-nonclim-", year, "-", mo, ".RDS")
folder = paste0(type, "-nonclim")
dat = readRDS(file = file.path(datadir_orig, folder, filename))
dat = dat %>% group_by(lon, lat) %>%
  summarize(val = mean(val, na.rm = TRUE))  %>%
  ungroup()
plot_dat(dat, add_map = TRUE)
```

Next, see remote sensing data before and after coarsening:

```{r coarsen, eval = FALSE}
dat_coarse = dat %>% long_format_to_image() %>% smoothmat(4) %>% image_to_long_format()
rbind(dat %>% complete_rectangle_barebones() %>% add_column(dat_type = "orig"),
      dat_coarse %>% add_column(dat_type = "coarsened")) %>% plot_dat()
```

Now, we're interested in comparing Darwin data and remote sensing data:

```{r}
twodat = sapply(c("real", "darwin"), function(type){
  filename = paste0(type, "-nonclim-", year, "-", mo, ".RDS")
  folder = paste0(type, "-nonclim")
  dat = readRDS(file = file.path(datadir_orig, folder, filename))
  dat = dat %>% group_by(lon, lat) %>%
    summarize(val = mean(val, na.rm = TRUE))  %>%
    ungroup()
  return(dat)
}, simplify = FALSE, USE.NAMES = TRUE) 
##   bind_rows(.id="dat_type")
## twodat %>% filter(dat_type == "darwin") %>%
##   group_by(lon, lat) %>%
##   count() %>% pull(n) 
  
smooth_pipeline <- function(dat, size){
  dat %>% dplyr::select(lon, lat, val) %>%
    long_format_to_image() %>%
    smoothmat(size) %>%
    image_to_long_format() %>%
    as_tibble()
}
twodat_coarse = twodat %>% purrr::map(. %>% smooth_pipeline(4))
twodat_coarse %>% bind_rows(.id = "dat_type")
res = omd(twodat_coarse[["darwin"]], twodat_coarse[["real"]])


nm1 = "real"
nm2 = "darwin"
twodat = merge(twodat_coarse[["real"]],
               twodat_coarse[["darwin"]], by = c("lat", "lon"),
               suffixes = c(".r", ".d")) %>% as_tibble() %>%
  rename(!!(nm1) := val.r, !!(nm2) := val.d) %>% 
  pivot_longer(cols = c(nm1, nm2), names_to = "dat_type", values_to = "val")

## Estimate OMD
res = omd(M1_long = twodat %>% filter(dat_type == nm1),
          M2_long = twodat %>% filter(dat_type == nm2),
          p = 2) ## Takes way too much memory; send it to a server.
plot_omd(res)
```



Then, we'll obtain coarsened versions of this data, and save it as
`datlist_darwin_by_resolution` and `datlist_real_by_resolution`.


Things to resolve:

1. Should I use `coarsen()` or `smoothmat()`?
2. What is the conversion between matrix and data tables?
* Matrix --> Data is.. `what()`?
* Data --> Matrix is `make_mat()`
3. Should long_format_to_image be able to handle multiple months' worth of data

Then, compare the data at a given resolution `res`.

```{r}
```


