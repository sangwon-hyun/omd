---
title: Lat/lon analysis of climatology Chlorophyll data
date: "Compiled at `r format(Sys.time(), '%Y-%m-%d %H:%M:%S', tz = 'UTC')` UTC"
output: 
  github_document: default
---

```{r global_options, include=TRUE, message = FALSE}
knitr::opts_chunk$set(fig.width=14, fig.height=8, echo=TRUE, eval=TRUE, cache=TRUE,
                      warning=FALSE, message=FALSE)

## Load packages
library(tidyverse, quietly = TRUE)
library(ggrepel, quietly = TRUE)
library(knitr, quietly = TRUE)
library(here, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(ggstar, quietly = TRUE)
library(omd, quietly = TRUE)
sf::sf_use_s2(FALSE)
```

The R package `omd` to use is here [https://github.com/sangwon-hyun/omd/](https://github.com/sangwon-hyun/omd/).
 
```{r directories}
base = "01-climatology"
here::i_am("01-climatology.Rmd")
knitr::opts_chunk$set(fig.path = here::here("data", base, 'figures/'))
datadir = here::here("data", base)
datadir_orig = here::here("data", "00-import-data")
if(!dir.exists(datadir)) dir.create(datadir)
source(here::here("01-helpers.R"))
figdir = here::here("figures")
```

Here's the box we'll focus on.

```{r box}
lat = 19.8968
lon = -155.5828
boxsize = 40
lonrange = lon + c(-1,1) * boxsize
latrange = lat + c(-1,1) * boxsize
latrange = pmin(latrange, 48.25)
latrange = pmax(latrange, -20.5)
restrictbox <- . %>% filter(lat > latrange[1],
                            lat < latrange[2],
                            lon > lonrange[1],
                            lon < lonrange[2])
world <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
```

## Load data

First, we load Darwin data (from https://github.com/brorfred/ocean_clustering/)
at 2-degree resolution.

```{r read-data}
ddat = read.csv(file.path(datadir_orig, "tabulated_darwin_montly_clim_090_180_ver_0_2_6.csv")) %>% as_tibble()
rdat = read.csv(file.path(datadir_orig, "tabulated_geospatial_montly_clim_090_180_ver_0_2_5.csv")) %>% as_tibble()
```

## Gather data

All twelve month's worth of data is first gathered into two list objects.

```{r gather-data}
## Get 24 months' worth of data
realdat_list = lapply(1:12, function(mo){ 
  rdat %>% restrictbox() %>% dplyr::filter(month == mo) %>% 
    dplyr::select(month, lat, lon, val = Chl)
})
names(realdat_list) = paste0("r", 1:12)

darwindat_list = lapply(1:12, function(mo){
  ddat %>% restrictbox() %>% dplyr::filter(month == mo) %>% 
    dplyr::select(month, lat, lon, val = Chl)
})
names(darwindat_list) = paste0("d", 1:12)
alldat_list = c(realdat_list, darwindat_list)

## Removing landlocked points
remove_landlock <- . %>%
  dplyr::mutate(land = mark_land(lon, lat, overreact = TRUE, buffer_in_km = 250)) %>%
  dplyr::filter(land == FALSE)  %>%
  dplyr::select(-land)

## Making common set of lon, lats.
alldat_list = alldat_list %>%
  purrr::map(. %>%
             remove_landlock() %>%
             dplyr::select(lon, lat, val) %>% 
             complete_rectangle() %>%
             dplyr::arrange(lon, lat))


## Check that all lon, lats are exactly the same
all_lonlats = alldat_list %>% purrr::map(. %>% dplyr::select(lon, lat))
for(ii in 1:length(all_lonlats)){
  stopifnot(all(all_lonlats[[ii]] == all_lonlats[[1]]))
}
```


## Top row of Figure 2

Calculate OMD.

```{r calculate-omd}
## Get the two datasets
name1 = "d4"
name2 = "r4"
name1_long = "Darwin data (April)"
name2_long = "Remote sensing (April)"
d1 = alldat_list[[name1]]
d2 = alldat_list[[name2]]
twodat = combine(d1, d2, name1_long, name2_long)
plot_dat(twodat, add_map = TRUE)

## Calculate 1-Wasserstein
res = omd(M1_long = twodat %>% filter(dat_type == name1_long),
          M2_long = twodat %>% filter(dat_type == name2_long),
          p = 2,
          geodesic = TRUE)
```

Make plot of two maps from the two sources.

```{r clim-two-maps, fig.width=12, fig.height=6}
## 1. First map
limits = c(0, 0.00483)
colours = c("blue", "red", "yellow")
p1 = twodat %>% plot_dat(add_map = TRUE,
                         hide_legend = FALSE,
                         standardize = TRUE,
                         limits = limits,
                         colours = colours, legend_name = "Chlorophyll\n     PDF")

p1 = p1 + theme(legend.position="bottom") +
  theme(strip.text.x = element_text(size = rel(1.4))) +
  theme(legend.key.width = unit(2, "cm"))
plot(p1)
## ggsave(file.path(figdir, "climatology-maps-new.pdf"), width = 12, height=6)
```

Make plot of pixel-wise difference

```{r clim-pixelwise-diff, fig.width=6, fig.height=6}
## Second map
dat1 = twodat %>% filter(dat_type == name1_long)
dat2 = twodat %>% filter(dat_type == name2_long)
dat1$val = dat1$val / sum(dat1$val, na.rm = TRUE)
dat2$val = dat2$val / sum(dat2$val, na.rm = TRUE)
dat3 = dat2
dat3$val = dat1$val - dat2$val
dat3$dat_type = "Pixel-wise difference"
p2 = plot_dat(dat3, standardize = FALSE, add_map = TRUE) +
  theme(legend.position="bottom") +
  theme(legend.key.width = unit(1.5, "cm")) +
  theme(strip.text.x = element_text(size = rel(1.4))) +
  theme(legend.title=element_text(size=rel(1.2))) + 
  scale_fill_gradientn(colours = c("blue", "white", "red"),
                       limits = c(-0.003, 0.003),
                       name = "Difference",
                       na.value = "white")
plot(p2)
## ggsave(file.path(figdir, "climatology-diff-new.pdf"), width = 6, height=6)
```


```{r clim-transport-plot, fig.width=12, fig.height=12}
## 3. Transport plot
p = plot_omd_ggplot(res, add_map = TRUE, classify_quantile = TRUE)
p = p + ggtitle(label="Optimal transport pattern", subtitle="")
p = p + theme(plot.title = element_text(hjust = 0.5, size = rel(3.5)))
p = p + theme(strip.text = element_text(size = rel(2.5), colour = "black", face = "bold"))
p = p + theme(axis.text = element_text(size = rel(2.5)),
              axis.title = element_text(size = rel(2.5)))
p = p + theme(strip.text.x = element_text(size = rel(2.5)))
plot(p)
## ggsave(file.path(figdir, "climatology-omd-mid-new.pdf"), width = 12, height=12)
```


## Bottom row of Figure 2

Calculate distance matrix.

```{r calc-geo-distmat, eval = FALSE}
distmat = matrix(NA, 24, 24)
for(ii in 1:24){
  for(jj in 1:24){
    if(ii < jj){

      ## Calculate OMD
      res = omd(M1_long = alldat_list[[ii]],
                M2_long = alldat_list[[jj]],
                p = 2,
                geodesic = TRUE)
                ## costm = costm)
      plot_omd_ggplot(res)
      distmat[ii,jj] = distmat[jj,ii] = res$dist
    }
  }
} 
diag(distmat) = NA
colnames(distmat) = rownames(distmat) = names(alldat_list)
saveRDS(distmat, file = file.path(datadir, "geo-distmat-clim-p2-overreact.RDS"))
```

Plot distance matrix.

```{r distmat-plot, fig.width = 6, fig.height = 6}
## Load distance matrix
datadir = "~/repos/omd/main/data/01-climatology"
distmat = readRDS(file = file.path(datadir, "geo-distmat-clim-p2-overreact.RDS"))
source("01-helpers.R")
p = plot_distmat_ggplot_clim(distmat)
p = p + theme(legend.position = "left") 
plot(p)
plotfilename = "distmat-climatology-overreact.pdf"
## ggsave(file.path(figdir, plotfilename), width = 6, height=6)
```

Plotting MDS plot.

```{r mds-plot, fig.width = 6, fig.height = 5}
## Load distance matrix
distmat = readRDS(file = file.path(datadir, "geo-distmat-clim-p2-overreact.RDS"))
p = make_mds_plot(distmat)
plot(p)
## ggsave(file = file.path(figdir, "mds-climatology-overreact.pdf"), width = 6, height = 5) 
```



## Figure 1 (Toy example)

We'll use a larger box, just for illustration.

```{r toy-box}
lat = 19.8968
lon = -155.5828
boxsize = 60
lonrange = lon + c(-1,1)*boxsize
latrange = lat + c(-1,1)*boxsize
lonrange = lon + c(-1,1)*boxsize
latrange = lat + c(-1,1)*boxsize
restrictbox <- . %>% filter(lat > latrange[1],
                            lat < latrange[2],
                            lon > lonrange[1],
                            lon < lonrange[2])
```


Toy example map.

```{r toy-map, fig.width = 5, fig.height=5}
ddat = read.csv(file.path(datadir_orig, "tabulated_darwin_montly_clim_090_180_ver_0_2_6.csv")) %>% as_tibble()
rdat = read.csv(file.path(datadir_orig, "tabulated_geospatial_montly_clim_090_180_ver_0_2_5.csv")) %>% as_tibble()
mo = 1
darwindat = ddat %>% dplyr::filter(month == mo) %>%  dplyr::select(month, lat, lon, val = Chl)  
darwindat = darwindat %>% restrictbox()


p1 = plot_dat(darwindat %>% 
              add_blob(c(-150 + (10*0), -25),
                       rotate = 0),
              add_map = TRUE)
p1 = p1 + labs(title = "Map 1")
p1 = p1 + theme(plot.title = element_text(hjust = 0.5))
plot(p1) 

plot(p1)
## ggsave(file = file.path("~/Desktop", "toy-map-orig-new.png"), width = 5, height=5) ## temporary
## ggsave(file = file.path(figdir, "toy-map-orig-without-star.png"), width = 3.5, height=5)

p2 = plot_dat(darwindat %>%
              add_blob(c(-150 + (10*0 ), -25),
                       rotate = 0) %>%
              add_blob(c(-150 + (10*2), -25),
                       rotate = (5 * 2 / 20) * 90) %>% 
              add_blob(c(-150 + (10*4), -25),
                       rotate = (5 * 4 / 20) * 90),
              add_map = TRUE)
arrowdat1 = data.frame(x=c(-150, -150+40), y=c(-25, -25) + .2)
arrowdat2 = data.frame(x=c(-150, -150+20), y=c(-25, -25) - .2)
p2 = p2 + geom_line(aes(x=x, y=y), arrow = arrow(length = unit(0.05*2, "inches")), data = arrowdat1, lwd = rel(2), col = rgb(0,0,0,0.6))
p2 = p2 + geom_line(aes(x=x, y=y), arrow = arrow(length = unit(0.05*2, "inches")), data = arrowdat2, lwd = rel(2), col = rgb(0,0,0,0.6))
p2 = p2 + labs(title = "Map 2")
p2 = p2 + theme(plot.title = element_text(hjust = 0.5))
plot(p2)
## ggsave(file = file.path(figdir, "toy-map-new.png"), width = 3.5, height=5) ## temporary
```

Toy distances.

```{r toy-dists-compute, eval = FALSE}
start.time = Sys.time()
dists = mclapply(1:20, function(ii){

  dat1 = darwindat %>% add_blob(c(-150, -25))
  dat2 = darwindat %>% add_blob(c(-150 + 2*ii, -25), rotate = (ii / 20) * 90)

  val1 = dat1 %>% pull(val)
  val2 = dat2 %>% pull(val)

  costm = form_cost_matrix(dat1)
  res = omd(M1_long = dat1,
            M2_long = dat2,
            p = 1,
            ## costm = costm,
            geodesic = TRUE)

  diffval = val1 - val2
  twodists = c(omd = res$dist, rmse = sqrt(sum((diffval)^2)))

  return(twodists)
}, mc.cores = 3)

distmat = do.call(rbind, dists) %>% as_tibble()  %>%
  tibble::add_column(shift = 2*(1:20)) %>%
  mutate(omd = omd-min(omd), rmse = rmse-min(rmse)) %>% 
  mutate(omd = omd/max(omd), rmse = rmse/max(rmse)) %>% 
  tidyr::pivot_longer(cols = c('omd', 'rmse')) 

saveRDS(distmat, file = file.path(datadir, "distmat-toy.RDS"))
```

Plotting two distances in one plot, as two lines.

```{r toy-dists, fig.width=4, fig.height=5}
distmat = readRDS(file = file.path(datadir, "distmat-toy.RDS"))

distmat = distmat %>% mutate(name = str_replace(name, "omd", "Wasserstein distance"))
distmat = distmat %>% mutate(name = str_replace(name, "rmse", "RMSE"))

p = ggplot(distmat) +
  geom_line(aes(x = shift, y = value, col = name), lwd = 2) +
  theme_minimal() +
  ylab("Distance, scaled to (0, 1)") +
  xlim(c(0,40)) +
  guides(col = guide_legend(title="Distance measure")) +
  theme(legend.position = c(0.7, 0.25)) +
  xlab("Longitude shift of patch")
plot(p)
p = p + labs(title = "Comparing Map1 and Map2")
p = p + theme(plot.title = element_text(hjust = 0.5))
## ggsave(file = file.path(figdir, "toy-dists-new.png"), width = 3.5, height =4.2)
```


